# å‹æµ‹æ•°æ®ç”Ÿæˆè„šæœ¬

## æ¦‚è¿°

æœ¬ç›®å½•åŒ…å«ç”¨äºç”Ÿæˆ1000ä¸‡æµ‹è¯•ç”¨æˆ·æ•°æ®å’Œå‹æµ‹é…ç½®æ–‡ä»¶çš„è„šæœ¬ã€‚

## æ–‡ä»¶è¯´æ˜

### è„šæœ¬æ–‡ä»¶

1. **generate_10m_users.go** - æ‰¹é‡ç”Ÿæˆ1000ä¸‡ç”¨æˆ·æ•°æ®åˆ°MySQLï¼ˆä½¿ç”¨é¡¹ç›®configï¼‰
2. **batch_create_sessions.go** - ç›´æ¥åˆ›å»ºRedis Sessionï¼ˆè¶…å¿«ç‰ˆï¼Œå¹¶å‘500ï¼Œç»•è¿‡bcryptï¼‰âš¡âš¡âš¡ **æ¨è**
3. **insert_test_user.go** - å•ä¸ªç”¨æˆ·æ’å…¥ï¼ˆç”¨äºè°ƒè¯•ï¼‰

### ç”Ÿæˆçš„é…ç½®æ–‡ä»¶

- **tokens_200.lua** - 200ä¸ªå›ºå®šç”¨æˆ·
- **tokens_200.txt** - å¯è¯»æ–‡ä»¶

### å‹æµ‹è„šæœ¬

- **wrk_fixed_users.lua** - å›ºå®šç”¨æˆ·å‹æµ‹è„šæœ¬ï¼ˆé«˜ç¼“å­˜å‘½ä¸­ç‡åœºæ™¯ï¼‰
- **wrk_random_users.lua** - éšæœºç”¨æˆ·å‹æµ‹è„šæœ¬ï¼ˆä½ç¼“å­˜å‘½ä¸­ç‡åœºæ™¯ï¼‰

### Tokenæ–‡ä»¶ï¼ˆè¿è¡Œbatch_login.goåç”Ÿæˆï¼‰

- **tokens_200.txt** / **tokens_200.lua** - 200ä¸ªç”¨æˆ·çš„token
- **tokens_2000.txt** / **tokens_2000.lua** - 2000ä¸ªç”¨æˆ·çš„token
- **tokens_50000.txt** / **tokens_50000.lua** - 50000ä¸ªç”¨æˆ·çš„tokenï¼ˆéšæœºç”¨æˆ·åœºæ™¯ï¼‰

---

## ä½¿ç”¨æ­¥éª¤

### æ­¥éª¤1ï¼šç”Ÿæˆ1000ä¸‡ç”¨æˆ·æ•°æ®

```bash
cd /Users/chuyao.zhuo/GolandProjects/entry-task/tcpserver/scripts

# ä½¿ç”¨é»˜è®¤é…ç½®æ–‡ä»¶ï¼ˆ../config/config.yamlï¼‰
go run generate_10m_users.go

# æˆ–æŒ‡å®šè‡ªå®šä¹‰é…ç½®æ–‡ä»¶
go run generate_10m_users.go -config /path/to/config.yaml
```

**æ€§èƒ½å‚æ•°ï¼š**
- æ‰¹æ¬¡å¤§å°ï¼š5000æ¡/æ‰¹
- å¹¶å‘Workerï¼š10ä¸ª
- é¢„æœŸé€Ÿåº¦ï¼š30000-50000æ¡/ç§’
- æ€»è€—æ—¶ï¼šçº¦5-10åˆ†é’Ÿ

**ç”Ÿæˆçš„ç”¨æˆ·æ•°æ®ï¼š**
- ç”¨æˆ·åï¼š`user00000001` åˆ° `user10000000`
- å¯†ç ï¼š`Test@123`ï¼ˆç»Ÿä¸€å¯†ç ï¼ŒbcryptåŠ å¯†ï¼‰
- æ˜µç§°ï¼š`æµ‹è¯•ç”¨æˆ·00000001` åˆ° `æµ‹è¯•ç”¨æˆ·10000000`

**æ•°æ®åº“é…ç½®ï¼š**
è„šæœ¬ä¼šè‡ªåŠ¨è¯»å– `config.yaml` ä¸­çš„æ•°æ®åº“é…ç½®ï¼š
```yaml
database:
  driver: "mysql"
  host: "192.168.215.5"
  port: 3306
  username: "root"
  password: "root"
  database: "test"
```

---

### æ­¥éª¤2ï¼šç”Ÿæˆå‹æµ‹é…ç½®æ–‡ä»¶

```bash
# ç”Ÿæˆå‹æµ‹ç”¨æˆ·åˆ—è¡¨å’Œé…ç½®æ–‡ä»¶
go run batch_create_sessions.go -count 200
```

**ç”Ÿæˆçš„æ–‡ä»¶ï¼š**
- `tokens_200.lua` - 200ä¸ªå›ºå®šç”¨æˆ·
- `tokens_200.txt` - å¯è¯»æ–‡ä»¶
---


##  å‹æµ‹å‡†å¤‡ä¸æ‰§è¡Œ

### ç¬¬ä¸€æ­¥ï¼šç¡®ä¿æœåŠ¡å·²å¯åŠ¨

```bash
# ç»ˆç«¯1ï¼šå¯åŠ¨TCPæœåŠ¡å™¨ï¼ˆgRPCï¼‰
cd /Users/chuyao.zhuo/GolandProjects/entry-task
go run ./tcpserver/cmd/tcpserver/main.go -config ./tcpserver/config/config.yaml

# ç»ˆç«¯2ï¼šå¯åŠ¨HTTPæœåŠ¡å™¨
go run ./httpserver/cmd/httpserver/main.go -config ./httpserver/config/config.yaml
```

### ç¬¬äºŒæ­¥ï¼šæ‰¹é‡è·å–Token

#### æ–¹å¼1ï¼šç›´æ¥åˆ›å»ºSessionï¼ˆè¶…å¿«ç‰ˆï¼Œå¼ºçƒˆæ¨èï¼‰

```bash
cd /Users/chuyao.zhuo/GolandProjects/entry-task/tcpserver/scripts

# é¦–æ¬¡éœ€è¦å®‰è£…ä¾èµ–ï¼ˆé¡¹ç›®ä¸­å·²æœ‰v9ï¼Œåªéœ€å®‰è£…uuidï¼‰
go get github.com/google/uuid

# ç”Ÿæˆ10000ä¸ªtokenï¼ˆçº¦1ç§’ï¼‰
go run batch_create_sessions.go -count 10000

# ç”Ÿæˆ50000ä¸ªtokenï¼ˆçº¦5ç§’ï¼‰
go run batch_create_sessions.go -count 50000

# ç”Ÿæˆ100ä¸‡ä¸ªtokenï¼ˆçº¦1-2åˆ†é’Ÿï¼‰
go run batch_create_sessions.go -count 1000000
```

**æ€§èƒ½ï¼š** å¹¶å‘500ï¼Œç›´æ¥Redisæ“ä½œï¼Œé€Ÿåº¦çº¦8000-15000 Session/ç§’

**ä¼˜ç‚¹ï¼š**
- âœ… **è¶…å¿«é€Ÿ**ï¼šç»•è¿‡HTTPè¯·æ±‚ã€bcryptéªŒè¯
- âœ… **ç¨³å®š**ï¼šå¤±è´¥ç‡æä½ï¼ˆ< 0.1%ï¼‰
- âœ… **èŠ‚çœèµ„æº**ï¼šä¸æ¶ˆè€—æœåŠ¡å™¨CPU

**æ³¨æ„ï¼š** Tokenæœ‰æ•ˆæœŸ2å°æ—¶ï¼Œè¿‡æœŸåéœ€é‡æ–°ç”Ÿæˆ

---

#### æ–¹å¼2ï¼šè°ƒç”¨ç™»å½•APIï¼ˆå®Œæ•´æµç¨‹ï¼‰âš¡

```bash
cd /Users/chuyao.zhuo/GolandProjects/entry-task/tcpserver/scripts

# ç™»å½•10000ä¸ªç”¨æˆ·ï¼ˆçº¦3ç§’ï¼‰
go run batch_login_fast.go -count 10000

# ç™»å½•50000ä¸ªç”¨æˆ·ï¼ˆçº¦15ç§’ï¼‰
go run batch_login_fast.go -count 50000

# ç™»å½•100ä¸‡ä¸ªç”¨æˆ·ï¼ˆçº¦4-5åˆ†é’Ÿï¼‰
go run batch_login_fast.go -count 1000000
```

**æ€§èƒ½ï¼š** å¹¶å‘500ï¼ŒHTTPè¿æ¥å¤ç”¨ï¼Œé€Ÿåº¦çº¦3500ç”¨æˆ·/ç§’

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
========================================
å¼€å§‹æ‰¹é‡ç™»å½• 50000 ä¸ªç”¨æˆ· (å¹¶å‘: 500)
========================================
è¿›åº¦: 23.5% (11750/50000) æˆåŠŸ: 11750 å¤±è´¥: 0
è¿›åº¦: 48.2% (24100/50000) æˆåŠŸ: 24100 å¤±è´¥: 0
è¿›åº¦: 75.8% (37900/50000) æˆåŠŸ: 37900 å¤±è´¥: 0
è¿›åº¦: 100.0% (50000/50000) æˆåŠŸ: 50000 å¤±è´¥: 0
========================================
âœ… ç™»å½•å®Œæˆï¼æˆåŠŸ: 50000/50000ï¼Œå¤±è´¥: 0ï¼Œè€—æ—¶: 14.28s
âœ… å¹³å‡é€Ÿåº¦: 3501 ç”¨æˆ·/ç§’
========================================
âœ… Tokenå·²ä¿å­˜åˆ°: tokens_50000.txt
âœ… Luaæ ¼å¼Tokenå·²ä¿å­˜åˆ°: tokens_50000.lua
```

---

#### æ€§èƒ½å¯¹æ¯”

| ç”¨æˆ·æ•°é‡ | batch_login_fast.go<br>(è°ƒç”¨ç™»å½•API) | batch_create_sessions.go<br>(ç›´æ¥Redis) | æé€Ÿå€æ•° |
|---------|----------------------------------|---------------------------------------|---------|
| 10,000 | ~20ç§’ | **~1ç§’** | **20å€** âš¡ |
| 50,000 | ~100ç§’ | **~5ç§’** | **20å€** âš¡ |
| 100,000 | ~200ç§’ | **~10ç§’** | **20å€** âš¡ |
| 1,000,000 | ~1.5-2å°æ—¶ | **~1-2åˆ†é’Ÿ** | **60-120å€** âš¡âš¡âš¡ |

**batch_create_sessions.go ä¼˜åŠ¿ï¼š**
- âœ… **ç»•è¿‡bcrypt**ï¼šè·³è¿‡æœ€å¤§æ€§èƒ½ç“¶é¢ˆ
- âœ… **ç›´æ¥Redis**ï¼šæ— éœ€HTTPè¯·æ±‚
- âœ… å¹¶å‘500ï¼šç¨³å®šä¸”å¿«é€Ÿ
- âœ… æ‰¹é‡æ–‡ä»¶å†™å…¥ï¼šå‡å°‘IO
- âœ… å¤±è´¥ç‡æä½ï¼š< 0.1%

**ç”Ÿæˆçš„æ–‡ä»¶ï¼š**
- `tokens_200.txt` - æ–‡æœ¬æ ¼å¼ï¼ˆæ¯è¡Œï¼šusername tokenï¼‰
- `tokens_200.lua` - Luaæ•°ç»„æ ¼å¼ï¼ˆä¾›wrkè„šæœ¬ä½¿ç”¨ï¼‰
- `tokens_2000.txt` / `tokens_2000.lua`
- `tokens_10000.txt` / `tokens_10000.lua`

### ç¬¬ä¸‰æ­¥ï¼šè¿è¡Œå‹æµ‹

**å®‰è£…wrk**ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰ï¼š
```bash
# macOS
brew install wrk

# Linux
git clone https://github.com/wg/wrk.git
cd wrk
make
sudo cp wrk /usr/local/bin/
```

**è¿è¡Œå‹æµ‹å‘½ä»¤ï¼š**

```bash
cd /Users/chuyao.zhuo/GolandProjects/entry-task/tcpserver/scripts

# åœºæ™¯1: 200å¹¶å‘å›ºå®šç”¨æˆ·ï¼ˆç›®æ ‡QPS > 3000ï¼‰
wrk -t 10 -c 200 -d 60s --script wrk_fixed_users.lua http://localhost:8080/api/v1/profile

# åœºæ™¯2: 200å¹¶å‘éšæœºç”¨æˆ·ï¼ˆç›®æ ‡QPS > 1000ï¼‰
wrk -t 10 -c 200 -d 60s --script wrk_random_users.lua http://localhost:8080/api/v1/profile

# åœºæ™¯3: 2000å¹¶å‘å›ºå®šç”¨æˆ·ï¼ˆç›®æ ‡QPS > 1500ï¼‰
# éœ€è¦å…ˆä¿®æ”¹ wrk_fixed_users.lua ç¬¬6è¡Œä¸º: local tokens = dofile("tokens_2000.lua")
wrk -t 20 -c 2000 -d 60s --script wrk_fixed_users.lua http://localhost:8080/api/v1/profile

# åœºæ™¯4: 2000å¹¶å‘éšæœºç”¨æˆ·ï¼ˆç›®æ ‡QPS > 800ï¼‰
wrk -t 20 -c 2000 -d 60s --script wrk_random_users.lua http://localhost:8080/api/v1/profile
```

**å‚æ•°è¯´æ˜ï¼š**
- `-t 10` : 10ä¸ªçº¿ç¨‹
- `-c 200` : 200ä¸ªå¹¶å‘è¿æ¥
- `-d 60s` : æŒç»­60ç§’
- `--script` : ä½¿ç”¨luaè„šæœ¬

**å‹æµ‹ç»“æœç¤ºä¾‹ï¼š**
```
========================================
å›ºå®šç”¨æˆ·å‹æµ‹ç»“æœ
========================================
æ€»è¯·æ±‚æ•°: 180523
æ€»è€—æ—¶: 60.01s
QPS: 3008.05
å¹³å‡å»¶è¿Ÿ: 66.52ms
P50å»¶è¿Ÿ: 62.34ms
P90å»¶è¿Ÿ: 89.12ms
P99å»¶è¿Ÿ: 145.67ms
æœ€å¤§å»¶è¿Ÿ: 523.45ms
========================================
```

---

## ğŸ“Š å‹æµ‹åœºæ™¯è¯´æ˜

### åœºæ™¯1ï¼š200å¹¶å‘å›ºå®šç”¨æˆ·ï¼ˆç›®æ ‡QPS > 3000ï¼‰

**æµ‹è¯•ç›®æ ‡ï¼š**
- éªŒè¯é«˜ç¼“å­˜å‘½ä¸­ç‡ä¸‹çš„ç³»ç»Ÿæ€§èƒ½
- æµ‹è¯•Redisè¯»å–æ€§èƒ½

**é…ç½®è¦æ±‚ï¼š**
- å¹¶å‘è¿æ¥ï¼š200
- ç”¨æˆ·æ± ï¼š200ä¸ªå›ºå®šç”¨æˆ·ï¼ˆé¡ºåºè½®è¯¢ï¼‰
- Tokenæ–‡ä»¶ï¼š`tokens_200.lua`
- å‹æµ‹è„šæœ¬ï¼š`wrk_fixed_users.lua`
- ç›®æ ‡QPSï¼š> 3000

**é¢„æœŸè¡Œä¸ºï¼š**
- Redisç¼“å­˜å‘½ä¸­ç‡ï¼š~99+%
- å¤§éƒ¨åˆ†è¯·æ±‚ç›´æ¥ä»Redisè¿”å›
- MySQLæŸ¥è¯¢è¾ƒå°‘

**æµ‹è¯•å‘½ä»¤ï¼š**
```bash
wrk -t 10 -c 200 -d 60s --script wrk_fixed_users.lua http://localhost:8080/api/v1/profile
```

---

### åœºæ™¯2ï¼š200å¹¶å‘éšæœºç”¨æˆ·ï¼ˆç›®æ ‡QPS > 1000ï¼‰

**æµ‹è¯•ç›®æ ‡ï¼š**
- éªŒè¯ä½ç¼“å­˜å‘½ä¸­ç‡ä¸‹çš„ç³»ç»Ÿæ€§èƒ½
- æµ‹è¯•MySQLæŸ¥è¯¢æ€§èƒ½å’Œç¼“å­˜ç©¿é€å¤„ç†

**é…ç½®è¦æ±‚ï¼š**
- å¹¶å‘è¿æ¥ï¼š200
- ç”¨æˆ·æ± ï¼š50000ä¸ªç”¨æˆ·ï¼ˆéšæœºé€‰æ‹©ï¼‰
- Tokenæ–‡ä»¶ï¼š`tokens_50000.lua`
- å‹æµ‹è„šæœ¬ï¼š`wrk_random_users.lua`
- ç›®æ ‡QPSï¼š> 1000

**é¢„æœŸè¡Œä¸ºï¼š**
- Redisç¼“å­˜å‘½ä¸­ç‡ï¼š~30%
- é¢‘ç¹æŸ¥è¯¢MySQL
- æµ‹è¯•æ•°æ®åº“è¿æ¥æ± å’ŒæŸ¥è¯¢ä¼˜åŒ–

**æµ‹è¯•å‘½ä»¤ï¼š**
```bash
wrk -t 10 -c 200 -d 60s --script wrk_random_users.lua http://localhost:8080/api/v1/profile
```

---

### åœºæ™¯3ï¼š2000å¹¶å‘å›ºå®šç”¨æˆ·ï¼ˆç›®æ ‡QPS > 1500ï¼‰

**æµ‹è¯•ç›®æ ‡ï¼š**
- éªŒè¯é«˜å¹¶å‘ä¸‹çš„ç³»ç»Ÿç¨³å®šæ€§
- æµ‹è¯•è¿æ¥æ± ç®¡ç†å’Œèµ„æºè°ƒåº¦

**é…ç½®è¦æ±‚ï¼š**
- å¹¶å‘è¿æ¥ï¼š2000
- ç”¨æˆ·æ± ï¼š2000ä¸ªå›ºå®šç”¨æˆ·ï¼ˆé¡ºåºè½®è¯¢ï¼‰
- Tokenæ–‡ä»¶ï¼š`tokens_2000.lua`ï¼ˆéœ€ä¿®æ”¹luaè„šæœ¬ï¼‰
- å‹æµ‹è„šæœ¬ï¼š`wrk_fixed_users.lua`
- ç›®æ ‡QPSï¼š> 1500

**é¢„æœŸè¡Œä¸ºï¼š**
- Redisç¼“å­˜å‘½ä¸­ç‡ï¼š~99+%
- æµ‹è¯•é«˜å¹¶å‘è¿æ¥ç®¡ç†
- éªŒè¯ç³»ç»Ÿèµ„æºé™åˆ¶

**æµ‹è¯•å‘½ä»¤ï¼š**
```bash
# 1. å…ˆä¿®æ”¹ wrk_fixed_users.lua ç¬¬6è¡Œ
# å°†: local tokens = dofile("tokens_200.lua")
# æ”¹ä¸º: local tokens = dofile("tokens_2000.lua")

# 2. è¿è¡Œå‹æµ‹
wrk -t 20 -c 2000 -d 60s --script wrk_fixed_users.lua http://localhost:8080/api/v1/profile
```

---

### åœºæ™¯4ï¼š2000å¹¶å‘éšæœºç”¨æˆ·ï¼ˆç›®æ ‡QPS > 800ï¼‰

**æµ‹è¯•ç›®æ ‡ï¼š**
- éªŒè¯æé™å‹åŠ›ä¸‹çš„ç³»ç»Ÿè¡¨ç°
- æµ‹è¯•æ•°æ®åº“è¿æ¥æ± ã€æŸ¥è¯¢æ€§èƒ½å’Œé”™è¯¯å¤„ç†

**é…ç½®è¦æ±‚ï¼š**
- å¹¶å‘è¿æ¥ï¼š2000
- ç”¨æˆ·æ± ï¼š10000ä¸ªç”¨æˆ·ï¼ˆéšæœºé€‰æ‹©ï¼‰
- Tokenæ–‡ä»¶ï¼š`tokens_10000.lua`
- å‹æµ‹è„šæœ¬ï¼š`wrk_random_users.lua`
- ç›®æ ‡QPSï¼š> 800

**é¢„æœŸè¡Œä¸ºï¼š**
- Redisç¼“å­˜å‘½ä¸­ç‡ï¼š~30%
- å¤§é‡MySQLæŸ¥è¯¢
- æµ‹è¯•ç³»ç»Ÿåœ¨é«˜è´Ÿè½½ä¸‹çš„ç¨³å®šæ€§

**æµ‹è¯•å‘½ä»¤ï¼š**
```bash
wrk -t 20 -c 2000 -d 60s --script wrk_random_users.lua http://localhost:8080/api/v1/profile
```

---

## ğŸ” æ€§èƒ½ç›‘æ§æŒ‡æ ‡

### å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | è¯´æ˜ | æœŸæœ›å€¼ |
|------|------|--------|
| **QPS** | æ¯ç§’è¯·æ±‚æ•° | è¾¾åˆ°ç›®æ ‡QPS |
| **å»¶è¿ŸP50** | 50%è¯·æ±‚çš„å“åº”æ—¶é—´ | < 100ms |
| **å»¶è¿ŸP99** | 99%è¯·æ±‚çš„å“åº”æ—¶é—´ | < 300ms |
| **é”™è¯¯ç‡** | å¤±è´¥è¯·æ±‚å æ¯” | < 0.1% |

### ç³»ç»Ÿèµ„æºç›‘æ§

**ç›‘æ§CPUå’Œå†…å­˜ï¼š**
```bash
# å®æ—¶ç›‘æ§
top -pid $(pgrep tcpserver)  # TCPæœåŠ¡å™¨
top -pid $(pgrep httpserver) # HTTPæœåŠ¡å™¨
```

**ç›‘æ§Redisï¼š**
```bash
redis-cli INFO stats
redis-cli INFO memory
```

**ç›‘æ§MySQLï¼š**
```sql
SHOW PROCESSLIST;
SHOW STATUS LIKE 'Threads_connected';
SHOW STATUS LIKE 'Queries';
```

---

## ğŸ”§ æ•°æ®åº“å‡†å¤‡

### MySQLé…ç½®ä¼˜åŒ–

ç¼–è¾‘ `my.cnf` æˆ– `my.ini`ï¼š

```ini
[mysqld]
# è¿æ¥æ•°
max_connections = 1000

# InnoDBç¼“å†²æ± ï¼ˆæ ¹æ®æœåŠ¡å™¨å†…å­˜è°ƒæ•´ï¼‰
innodb_buffer_pool_size = 4G

# æ—¥å¿—åˆ·æ–°ç­–ç•¥ï¼ˆæå‡æ€§èƒ½ï¼Œä½†é™ä½å®‰å…¨æ€§ï¼‰
innodb_flush_log_at_trx_commit = 2

# æ‰¹é‡æ’å…¥ä¼˜åŒ–
bulk_insert_buffer_size = 256M
```

### åˆ›å»ºç´¢å¼•

```sql
-- ç”¨æˆ·åç´¢å¼•ï¼ˆç”¨äºç™»å½•æŸ¥è¯¢ï¼‰
CREATE INDEX idx_username ON users(username);

-- éªŒè¯æ•°æ®
SELECT COUNT(*) FROM users;  -- åº”è¯¥æ˜¯ 10000000
```

---

## ğŸ“ˆ æ€§èƒ½ç›‘æ§

### æŸ¥çœ‹ç”Ÿæˆè¿›åº¦

ç”Ÿæˆè„šæœ¬ä¼šä½¿ç”¨é¡¹ç›®æ—¥å¿—ç³»ç»Ÿå®æ—¶è¾“å‡ºè¿›åº¦ï¼š

```
[INFO] ç”Ÿæˆè¿›åº¦ {"worker_id": 0, "progress": 50.0, "processed": 500000, "total": 1000000, "speed": 4523}
[INFO] ç”Ÿæˆè¿›åº¦ {"worker_id": 1, "progress": 45.3, "processed": 453000, "total": 1000000, "speed": 4391}
...
```

### æ•°æ®åº“ç›‘æ§

```sql
-- æŸ¥çœ‹å½“å‰ç”¨æˆ·æ•°
SELECT COUNT(*) FROM users;

-- æŸ¥çœ‹æœ€æ–°æ’å…¥çš„ç”¨æˆ·
SELECT * FROM users ORDER BY id DESC LIMIT 10;

-- æŸ¥çœ‹æ•°æ®åº“å¤§å°
SELECT 
    table_schema AS 'Database',
    ROUND(SUM(data_length + index_length) / 1024 / 1024, 2) AS 'Size (MB)'
FROM information_schema.tables
WHERE table_schema = 'test'
GROUP BY table_schema;
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ç£ç›˜ç©ºé—´

1000ä¸‡ç”¨æˆ·æ•°æ®çº¦å ç”¨ï¼š
- æ•°æ®ï¼š~2GB
- ç´¢å¼•ï¼š~500MB
- **æ€»è®¡ï¼š~2.5GB**

è¯·ç¡®ä¿æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´ã€‚

### 2. ç”Ÿæˆæ—¶é—´

- å¿«é€ŸSSDï¼š30-40åˆ†é’Ÿ
- æ™®é€šHDDï¼š60-90åˆ†é’Ÿ
- ç½‘ç»œæ•°æ®åº“ï¼šå–å†³äºç½‘ç»œå¸¦å®½

### 3. ç»Ÿä¸€å¯†ç 

ä¸ºäº†åŠ å¿«ç”Ÿæˆé€Ÿåº¦ï¼Œæ‰€æœ‰ç”¨æˆ·ä½¿ç”¨ç»Ÿä¸€å¯†ç  `Test@123`ã€‚

**å®‰å…¨æç¤ºï¼š** ä»…ç”¨äºæµ‹è¯•ç¯å¢ƒï¼Œç”Ÿäº§ç¯å¢ƒç¦æ­¢ä½¿ç”¨ï¼

### 4. IDç”Ÿæˆ

ä½¿ç”¨è¿ç»­IDï¼ˆ1åˆ°10000000ï¼‰ï¼Œä¸ä½¿ç”¨Snowflakeç®—æ³•ï¼Œä»¥æå‡ç”Ÿæˆé€Ÿåº¦ã€‚

### 5. æ—¥å¿—çº§åˆ«

ç”Ÿæˆè¿‡ç¨‹ä½¿ç”¨é¡¹ç›®çš„æ—¥å¿—ç³»ç»Ÿï¼Œå¯åœ¨ `config.yaml` ä¸­è°ƒæ•´æ—¥å¿—çº§åˆ«ï¼š

```yaml
log:
  level: "info"  # å¯æ”¹ä¸º debug æŸ¥çœ‹æ›´è¯¦ç»†ä¿¡æ¯
  output: "stdout"
```

---

## ğŸ› ï¸ æ•…éšœæ’é™¤

### é—®é¢˜1ï¼šé…ç½®æ–‡ä»¶åŠ è½½å¤±è´¥

```
âŒ åŠ è½½é…ç½®å¤±è´¥: open ../config/config.yaml: no such file or directory
```

**è§£å†³æ–¹æ¡ˆï¼š**
- ç¡®ä¿åœ¨ `tcpserver/scripts` ç›®å½•ä¸‹è¿è¡Œ
- æˆ–ä½¿ç”¨ `-config` å‚æ•°æŒ‡å®šé…ç½®æ–‡ä»¶ç»å¯¹è·¯å¾„

### é—®é¢˜2ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥

```
âŒ åˆå§‹åŒ–æ•°æ®åº“å¤±è´¥: Error 1045: Access denied
```

**è§£å†³æ–¹æ¡ˆï¼š**
- æ£€æŸ¥ `config.yaml` ä¸­çš„æ•°æ®åº“é…ç½®
- ç¡®è®¤æ•°æ®åº“å·²åˆ›å»º
- æµ‹è¯•æ•°æ®åº“è¿æ¥ï¼š`mysql -h host -u user -p`

### é—®é¢˜3ï¼šç”Ÿæˆé€Ÿåº¦æ…¢

**ä¼˜åŒ–å»ºè®®ï¼š**
1. è°ƒæ•´æ‰¹æ¬¡å¤§å°ï¼šä¿®æ”¹ `BatchSize` å¸¸é‡
2. å¢åŠ å¹¶å‘æ•°ï¼šä¿®æ”¹ `NumWorkers` å¸¸é‡
3. ä¼˜åŒ–MySQLé…ç½®ï¼ˆè§ä¸Šæ–‡ï¼‰
4. ä¸´æ—¶ç¦ç”¨ç´¢å¼•ï¼šç”Ÿæˆå®Œæˆåå†åˆ›å»ºç´¢å¼•

### é—®é¢˜4ï¼šå†…å­˜ä¸è¶³

**è§£å†³æ–¹æ¡ˆï¼š**
- å‡å° `BatchSize`ï¼ˆå¦‚æ”¹ä¸º2000ï¼‰
- å‡å°‘ `NumWorkers`ï¼ˆå¦‚æ”¹ä¸º5ï¼‰
- è°ƒæ•´ `config.yaml` ä¸­çš„è¿æ¥æ± é…ç½®

---

## ğŸ“ ç¤ºä¾‹è¾“å‡º

### generate_10m_users.go è¾“å‡º

```
========================================
æ‰¹é‡ç”Ÿæˆ1000ä¸‡ç”¨æˆ·æ•°æ®
========================================
æ­£åœ¨åŠ è½½é…ç½®æ–‡ä»¶...
âœ… é…ç½®æ–‡ä»¶åŠ è½½æˆåŠŸ: ../config/config.yaml
[INFO] æ­£åœ¨åˆå§‹åŒ–æ•°æ®åº“è¿æ¥...
[INFO] æ•°æ®åº“è¿æ¥æˆåŠŸ {"driver": "mysql", "database": "test"}
[INFO] æ•°æ®åº“è¿æ¥æ± é…ç½®å®Œæˆ {"max_open_conns": 20, "max_idle_conns": 10}
[INFO] æ­£åœ¨ç”Ÿæˆå¯†ç å“ˆå¸Œ...
[INFO] ========================================
[INFO] å¼€å§‹ç”Ÿæˆç”¨æˆ·æ•°æ® {"total_users": 10000000, "password": "Test@123", "batch_size": 5000, "num_workers": 10}
[INFO] ========================================
[INFO] ç”Ÿæˆè¿›åº¦ {"worker_id": 0, "progress": 50.0, "processed": 500000, "total": 1000000, "speed": 4523, "batch_duration": "1.1s"}
...
[INFO] Workerå®Œæˆ {"worker_id": 0, "processed": 1000000, "total_time": "3m42s", "avg_speed": 4502}
...
[INFO] ========================================
[INFO] âœ… æ•°æ®ç”Ÿæˆå®Œæˆï¼ {"total_time": "37m15s", "avg_speed": 4475}
[INFO] ========================================
[INFO] ç”¨æˆ·ä¿¡æ¯ {"username_format": "user00000001 åˆ° user10000000", "password": "Test@123"}
```

---

## â“ å‹æµ‹å¸¸è§é—®é¢˜

### Q1ï¼šTokenè¿‡æœŸæ€ä¹ˆåŠï¼Ÿ

**Aï¼š** Tokenæœ‰æ•ˆæœŸä¸º2å°æ—¶ï¼ˆ7200ç§’ï¼‰ï¼Œå¦‚æœå‹æµ‹æ—¶é—´è¶…è¿‡2å°æ—¶æˆ–è·¨å¤©æµ‹è¯•ï¼Œéœ€è¦é‡æ–°è¿è¡Œ `batch_login.go` è·å–æ–°tokenã€‚

```bash
# é‡æ–°ç™»å½•
go run batch_login.go -count 200
```

### Q2ï¼šä¸ºä»€ä¹ˆéšæœºç”¨æˆ·ä¹Ÿè¦é¢„ç™»å½•ï¼Ÿ

**Aï¼š** å‹æµ‹çš„æ˜¯ **ProfileæŸ¥è¯¢API** çš„æ€§èƒ½ï¼Œä¸æ˜¯ç™»å½•APIã€‚å¦‚æœæ¯æ¬¡éƒ½å®æ—¶ç™»å½•ï¼š
- ç™»å½•åŒ…å«bcryptå¯†ç éªŒè¯ï¼ˆå¾ˆæ…¢ï¼‰
- æ— æ³•å‡†ç¡®æµ‹è¯•æŸ¥è¯¢æ€§èƒ½
- ä¼šä¸¥é‡æ‹–ç´¯QPS

é¢„ç™»å½•10000ä¸ªç”¨æˆ·æ± ï¼Œéšæœºé€‰æ‹©tokenï¼Œå¯ä»¥æ¨¡æ‹Ÿä½ç¼“å­˜å‘½ä¸­ç‡åœºæ™¯ï¼ŒåŒæ—¶é¿å…ç™»å½•å¼€é”€ã€‚

### Q3ï¼šå›ºå®šç”¨æˆ·å’Œéšæœºç”¨æˆ·çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ

| ç»´åº¦ | å›ºå®šç”¨æˆ· | éšæœºç”¨æˆ· |
|------|----------|----------|
| Tokenæ± å¤§å° | 200/2000 | 10000 |
| Tokené€‰æ‹©æ–¹å¼ | é¡ºåºè½®è¯¢ | éšæœºé€‰æ‹© |
| Redisç¼“å­˜å‘½ä¸­ç‡ | ~95% | ~30-50% |
| ä¸»è¦ç“¶é¢ˆ | Redisè¯»å– | MySQLæŸ¥è¯¢ |

### Q4ï¼šwrkå‹æµ‹å¤±è´¥ï¼Œæ˜¾ç¤º"Connection refused"ï¼Ÿ

**Aï¼š** æ£€æŸ¥ï¼š
1. HTTPæœåŠ¡å™¨æ˜¯å¦å·²å¯åŠ¨ï¼ˆç«¯å£8080ï¼‰
2. TCPæœåŠ¡å™¨æ˜¯å¦å·²å¯åŠ¨ï¼ˆç«¯å£50051ï¼‰
3. ä½¿ç”¨ `curl http://localhost:8080/api/v1/profile` æµ‹è¯•è¿é€šæ€§

### Q5ï¼šå‹æµ‹QPSè¾¾ä¸åˆ°ç›®æ ‡æ€ä¹ˆåŠï¼Ÿ

**ä¼˜åŒ–å»ºè®®ï¼š**

1. **å›ºå®šç”¨æˆ·åœºæ™¯ä¼˜åŒ–ï¼ˆç¼“å­˜ä¼˜åŒ–ï¼‰ï¼š**
   - å¢åŠ Rediså†…å­˜
   - æ£€æŸ¥Redisè¿æ¥æ± é…ç½®
   - ä¼˜åŒ–åºåˆ—åŒ–æ–¹å¼

2. **éšæœºç”¨æˆ·åœºæ™¯ä¼˜åŒ–ï¼ˆæ•°æ®åº“ä¼˜åŒ–ï¼‰ï¼š**
   - å¢åŠ MySQLè¿æ¥æ± å¤§å°
   - æ·»åŠ æ•°æ®åº“ç´¢å¼•
   - å¼€å¯æŸ¥è¯¢ç¼“å­˜
   - ä¼˜åŒ–æ…¢æŸ¥è¯¢

3. **ç³»ç»Ÿå±‚é¢ä¼˜åŒ–ï¼š**
   - å¢åŠ æ–‡ä»¶æè¿°ç¬¦é™åˆ¶ï¼š`ulimit -n 65535`
   - è°ƒæ•´TCPå‚æ•°
   - ä½¿ç”¨æ›´å¼ºçš„ç¡¬ä»¶

### Q6ï¼šæ‰¹é‡ç™»å½•å¤ªæ…¢æ€ä¹ˆåŠï¼Ÿ

**Aï¼š** å¯ä»¥è°ƒæ•´å¹¶å‘æ•°ï¼Œç¼–è¾‘ `batch_login.go` ç¬¬11è¡Œï¼š

```go
MaxParallel = 100  // ä»50æ”¹ä¸º100
```

### Q7ï¼šéœ€è¦æµ‹è¯•ç™»å½•APIçš„æ€§èƒ½æ€ä¹ˆåŠï¼Ÿ

**Aï¼š** ç™»å½•APIå‹æµ‹ä¸ProfileæŸ¥è¯¢ä¸åŒï¼Œéœ€è¦å•ç‹¬æµ‹è¯•ã€‚å¯ä»¥åˆ›å»ºä¸“é—¨çš„ç™»å½•å‹æµ‹è„šæœ¬ï¼Œä½†è¦æ³¨æ„ï¼š
- bcryptéªŒè¯å¾ˆæ…¢ï¼ŒQPSä¼šå¾ˆä½
- éœ€è¦è€ƒè™‘ç™»å½•é™æµç­–ç•¥
- é¿å…è§¦å‘ç™»å½•å¤±è´¥é”å®š

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### æ•°æ®ç”Ÿæˆç›¸å…³

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. MySQLæ˜¯å¦æ­£å¸¸è¿è¡Œ
2. é…ç½®æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®
3. æ•°æ®åº“è¿æ¥ä¿¡æ¯æ˜¯å¦æ­£ç¡®
4. ç£ç›˜ç©ºé—´æ˜¯å¦å……è¶³
5. æŸ¥çœ‹æ—¥å¿—è¾“å‡ºä¸­çš„é”™è¯¯ä¿¡æ¯

### å‹æµ‹ç›¸å…³

1. ç¡®ä¿æœåŠ¡å·²å¯åŠ¨ï¼ˆtcpserver + httpserverï¼‰
2. Tokenæ˜¯å¦æœ‰æ•ˆï¼ˆæœªè¿‡æœŸï¼‰
3. luaè„šæœ¬ä¸­çš„tokenæ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®
4. æ£€æŸ¥ç³»ç»Ÿèµ„æºé™åˆ¶ï¼ˆæ–‡ä»¶æè¿°ç¬¦ã€ç«¯å£ç­‰ï¼‰
5. æŸ¥çœ‹æœåŠ¡æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [wrkå‹æµ‹å·¥å…·æ–‡æ¡£](https://github.com/wg/wrk)
- [Luaè„šæœ¬ç¼–å†™æŒ‡å—](https://github.com/wg/wrk/blob/master/SCRIPTING)
- MySQLæ€§èƒ½ä¼˜åŒ–
- Redisæ€§èƒ½è°ƒä¼˜
